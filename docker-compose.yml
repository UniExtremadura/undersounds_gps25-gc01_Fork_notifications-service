services:
  db:
    image: mysql:8.1
    container_name: notifications_mysql
    environment:
      MYSQL_ROOT_PASSWORD: rootpassword
      MYSQL_DATABASE: notifications
      MYSQL_USER: notifications_user
      MYSQL_PASSWORD: notifications_password
    ports:
      - "3307:3306"
    volumes:
      - db_data:/var/lib/mysql

  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: notifications_app
    environment:
      DATABASE_URL: mysql://notifications_user:notifications_password@db:3306/notifications
      PORT: 3000
      NODE_ENV: production
      # ðŸ” KEYCLOAK CONFIG - Actualizado para el nuevo Keycloak
      KEYCLOAK_ISSUER: http://keycloak:8080/realms/undersounds
      KEYCLOAK_AUDIENCE: notifications-service
      KEYCLOAK_JWKS_URI: http://keycloak:8080/realms/undersounds/protocol/openid-connect/certs
      SMTP_HOST: localhost
      SMTP_PORT: 1025
      SMTP_USER: test
      SMTP_PASS: test
    ports:
      - "3000:3000"
    depends_on:
      - db
      - keycloak

  # âœ… CONFIGURACIÃ“N MEJORADA DE KEYCLOAK
  keycloak-db:
    image: mysql
    container_name: keycloak-db
    env_file: .env
    environment:
      MYSQL_DATABASE: ${KC_DB_NAME}
      MYSQL_ROOT_PASSWORD: ${KC_DB_ROOT_PASSWORD}
      MYSQL_USER: ${KC_DB_USER}
      MYSQL_PASSWORD: ${KC_DB_PASS}
    volumes:
      - keycloak-data:/var/lib/mysql
    healthcheck:
      test: [ "CMD", "mysqladmin", "ping", "-h", "localhost" ]
      interval: 5s
      retries: 5
      start_period: 10s
      timeout: 5s

  keycloak:
    image: quay.io/keycloak/keycloak:latest
    container_name: keycloak
    command:
      - start-dev
      - --import-realm
    env_file: .env
    environment:
      # Base de datos de Keycloak
      KC_DB: mysql
      KC_DB_URL: jdbc:mysql://keycloak-db:3306/${KC_DB_NAME}
      KC_DB_USERNAME: ${KC_DB_USER}
      KC_DB_PASSWORD: ${KC_DB_PASS}

      # ConfiguraciÃ³n de hostname para JWT
      KC_HOSTNAME: http://keycloak:8080
      KC_HOSTNAME_STRICT_BACKCHANNEL: "false"
      KC_HOSTNAME_ADMIN_URL: http://localhost:8090
      KC_HOSTNAME_STRICT: "false"
      KC_HTTP_ENABLED: "true"

      # MonitorizaciÃ³n y logging
      KC_LOG_LEVEL: DEBUG

      # ConfiguraciÃ³n del administrador
      KC_BOOTSTRAP_ADMIN_USERNAME: ${KC_ADMIN_USER}
      KC_BOOTSTRAP_ADMIN_PASSWORD: ${KC_ADMIN_PASS}
    volumes:
      - ./keycloak-export:/opt/keycloak/data/import:ro
    ports:
      - "8090:8080"  # âœ… Cambiado a 8090 como en tu configuraciÃ³n
    depends_on:
      keycloak-db:
        condition: service_healthy
    healthcheck:
      test: [ "CMD-SHELL", "{ printf >&3 'GET /realms/master/.well-known/openid-configuration HTTP/1.0\r\nHost: localhost\r\n\r\n'; cat <&3; } 3<>/dev/tcp/localhost/8080 | head -1 | grep 200"]
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 180s

volumes:
  db_data:
  keycloak-data: